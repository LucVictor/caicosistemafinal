{% extends "./template.html" %} {% block content %}
<style>
    #graficoContainer2 {
        max-width: 400px;
    }
    #graficoContainer {
        max-width: 400px;
    }
    #graficoLojasBarras {
        width: 400px;
        height: 250px;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<h2 class="m-2">
    Transferências de {{data_inicial.strftime('%d/%m/%Y')}} á
    {{data_final.strftime('%d/%m/%Y')}}:
</h2>
<br />
<h4 class="p-2">Total de transferências: {{total_transferencias}}.</h4>

<div class="row border container m-auto">
    <div class="col">
        <h4>Transferências por comprador:</h4>

        <div class="m-auto" id="graficoContainer2">
            <canvas id="graficoComprador"></canvas>
        </div>
    </div>

    <div
        class="col border d-flex justify justify-content-center align-items-center flex-column"
    >
        <h4>Transferências por lojas:</h4>
        <div class="m-auto" id="graficoLojasBarras">
            <canvas id="graficoLoja"></canvas>
        </div>
    </div>

    <div class="col">
        <h4>Transferências por tipo:</h4>
        <div class="m-auto" id="graficoContainer">
            <canvas id="graficoRosquinha"></canvas>
        </div>
    </div>
</div>
<hr />
<h4>Tabela</h4>

<div class="d-flex justify-content-center text-center">
    <div class="table-responsive w-100 p-3">
        <table class="table table-bordered text-center align-middle">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Nº Pedido</th>
                    <th>Loja</th>
                    <th>Tipo</th>
                    <th>Comprador</th>
                    <th>Observação</th>
                    <th>Ação</th>
                    <th>Criador</th>
                </tr>
            </thead>
            <tbody>
                {% for transferencia in transferencias %}
                <tr>
                    <td>{{ transferencia.data.strftime('%d/%m/%Y') }}</td>
                    <td>{{ transferencia.pedido }}</td>
                    <td>{{ transferencia.loja }}</td>
                    <td>{{ transferencia.tipo }}</td>
                    <td>{{ transferencia.comprador }}</td>
                    <td>{{ transferencia.obs }}</td>
                    <td class="botoesacao">
                        {% if current_user.is_authenticated and
                        current_user.username == transferencia.criador %}
                        <form
                            action="/transferencia/deletar/{{ transferencia.id }}"
                            method="get"
                        >
                            <input
                                class="btn btn-sm btn-warning"
                                type="submit"
                                value="Apagar"
                            />
                        </form>
                        {% endif %}
                    </td>
                    <td>{{ transferencia.criador }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    const tipos = {{ tipos | tojson }};
    const quantidades = {{ quantidades | tojson }};
    const total = quantidades.reduce((a, b) => a + b, 0);

    const compradores = {{ compradores | tojson }};
    const qtdTransferencias = {{ qtd_transferencias | tojson }};
    const totalCompras = qtdTransferencias.reduce((a, b) => a + b, 0);

    const lojas = {{ lojas | tojson }};
    const lojasQuantidades = {{ lojas_quantidades | tojson }};
    const totalLojas = lojasQuantidades.reduce((a, b) => a + b, 0);

    // Gráfico Rosquinha por Tipo
    const ctx = document.getElementById('graficoRosquinha').getContext('2d');
    const grafico = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: tipos,
            datasets: [{
                data: quantidades,
                backgroundColor: [
                    '#8E44AD', '#3498DB', '#1ABC9C', '#F39C12',
                    '#D35400', '#C0392B', '#7F8C8D', '#2ECC71'
                ],
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            plugins: {
                datalabels: {
                    formatter: (value) => `${((value / total) * 100).toFixed(1)}%\n(${value})`,
                    color: '#000',
                    font: { weight: 'bold', size: 14 }
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 20,
                        color: '#000',
                        generateLabels: function(chart) {
                            const data = chart.data;
                            const dataset = data.datasets[0];
                            return data.labels.map((label, i) => {
                                const value = dataset.data[i];
                                return {
                                    text: `${label} (${value})`,
                                    fillStyle: dataset.backgroundColor[i],
                                    strokeStyle: dataset.borderColor,
                                    lineWidth: 1,
                                    hidden: !chart.getDatasetMeta(0).data[i],
                                    index: i
                                };
                            });
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const value = context.raw;
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${context.label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Gráfico Rosquinha por Comprador
    const ctxComprador = document.getElementById('graficoComprador').getContext('2d');
    const graficoComprador = new Chart(ctxComprador, {
        type: 'doughnut',
        data: {
            labels: compradores,
            datasets: [{
                data: qtdTransferencias,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#E7E9ED', '#00A36C'
                ],
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            plugins: {
                datalabels: {
                    formatter: (value) => `${((value / totalCompras) * 100).toFixed(1)}%\n(${value})`,
                    color: '#000',
                    font: { weight: 'bold', size: 14 }
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 20,
                        color: '#000',
                        generateLabels: function(chart) {
                            const data = chart.data;
                            const dataset = data.datasets[0];
                            return data.labels.map((label, i) => {
                                const value = dataset.data[i];
                                return {
                                    text: `${label} (${value})`,
                                    fillStyle: dataset.backgroundColor[i],
                                    strokeStyle: dataset.borderColor,
                                    lineWidth: 1,
                                    hidden: !chart.getDatasetMeta(0).data[i],
                                    index: i
                                };
                            });
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const value = context.raw;
                            const percentage = ((value / totalCompras) * 100).toFixed(1);
                            return `${context.label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Gráfico Rosquinha por Loja
    const ctxLoja = document.getElementById('graficoLoja').getContext('2d');
    const graficoLoja = new Chart(ctxLoja, {
        type: 'bar',
        data: {
            labels: lojas,
            datasets: [{
                data: lojasQuantidades,
                backgroundColor: [
                    '#1F77B4', '#AEC7E8', '#FF7F0E', '#FFBB78',
                    '#2CA02C', '#98DF8A', '#D62728', '#FF9896'
                ],
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            plugins: {
                datalabels: {
                    formatter: (value) => `${((value / totalLojas) * 100).toFixed(1)}%\n(${value})`,
                    color: '#000',
                    font: { weight: 'bold', size: 14 }
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 20,
                        color: '#000',
                        generateLabels: function(chart) {
                            const data = chart.data;
                            const dataset = data.datasets[0];
                            return data.labels.map((label, i) => {
                                const value = dataset.data[i];
                                return {
                                    text: `${label} (${value})`,
                                    fillStyle: dataset.backgroundColor[i],
                                    strokeStyle: dataset.borderColor,
                                    lineWidth: 1,
                                    hidden: !chart.getDatasetMeta(0).data[i],
                                    index: i
                                };
                            });
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const value = context.raw;
                            const percentage = ((value / totalLojas) * 100).toFixed(1);
                            return `${context.label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
</script>
{% endblock %}
